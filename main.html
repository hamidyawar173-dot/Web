<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>WEATHER SEARCH APP</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Leaflet Map CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    body{
      margin:0;
      font-family: Inter, Arial, sans-serif;
      color: #fff;
      background: url('https://thumbs.dreamstime.com/b/incredibly-beautiful-sunset-sun-lake-sunrise-landscape-panorama-nature-sky-amazing-colorful-clouds-fantasy-design-115177001.jpg') center/cover no-repeat fixed;
    }

    .hero {
      min-height: 36vh;
      background: linear-gradient(180deg, rgba(0,0,0,0.45), rgba(0,0,0,0.2));
      display:flex;
      flex-direction:column;
      padding:18px 20px;
    }

    .topbar {
      display:flex;
      justify-content:space-between;
      max-width:1100px;
      margin:0 auto;
      width:100%;
    }

    .brand {
      font-weight:700;
      font-size:20px;
    }

  .hero-center {
    display:flex;
    justify-content:left;   
    width:100%;
    margin-top:auto;
    margin-bottom:auto;
    padding:28px 0;
  }

  .search-wrap{
    width:min(820px, 92%);
    display:flex;
    gap:8px;
    margin-left:105px; 
              /* Add left spacing */
  }

    .search-input{
      flex:1;
      background:#fff;
      border-radius:8px;
      padding:10px 12px;
      box-shadow:0 6px 18px rgba(0,0,0,0.15);
      display:flex;
      
    }

    .search-input input{
      border:0;
      outline:0;
      width:100%;
      font-size:16px;

    }

    .search-action{
      background:#fff;
      border-radius:8px;
      padding:10px 20px;
      cursor:pointer;
      font-weight:700;
      color:#1e3a8a;
      box-shadow:0 6px 18px rgba(0,0,0,0.15);
      margin-left: -30;
    }

    .content{
      max-width:1100px;
      margin:22px auto;
      padding:0 18px 48px;
    }

    h3.section-title{
      color:#fff;
      margin:18px 0;
      font-size:14px;
      text-transform:uppercase;
      letter-spacing:1px;
    }

    .history{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }

    .card{
      width:240px;
      padding:18px;
      border-radius:12px;
      background:rgba(255,255,255,0.08);
      backdrop-filter:blur(8px);
      box-shadow:0 10px 28px rgba(0,0,0,0.45);
      cursor:pointer;
      transition:0.2s ease;
    }

    .card:hover{
      transform:translateY(-4px);
      box-shadow:0 14px 34px rgba(0,0,0,0.55);
    }

    .city{font-size:18px;font-weight:700;}
    .country{font-size:12px;opacity:0.85;margin-bottom:6px;}
    .mid-row{display:flex;align-items:center;gap:10px;margin:10px 0;}
    .temp{font-size:28px;font-weight:700;}

    #owmMap {
      width:100%;
      height:380px;
      margin-top:16px;
      border-radius:12px;
      border:2px solid rgba(255,255,255,0.45);
      box-shadow:0 10px 26px rgba(0,0,0,0.45);
    }

    .map-search-box{
      margin-top:12px;
      display:flex;
      gap:8px;
    }

    .map-search-box input{
      flex:1;
      padding:10px 12px;
      border-radius:8px;
      border:0;
      font-size:15px;
      color:#111;
    }

    .map-search-box button{
      padding:10px 18px;
      border-radius:8px;
      background:#fff;
      color:#1e3a8a;
      font-weight:700;
      cursor:pointer;
      border:0;
      box-shadow:0 6px 18px rgba(0,0,0,0.20);
    }

    #locateMeBtn{
      background:#0d9488 !important;
      color:#fff !important;
    }

  </style>
</head>

<body>

<header class="hero">
  <div class="topbar">
    <div class="brand">WEATHER SEARCH APP</div>
  </div>

  <div class="hero-center">
    <div class="search-wrap">
      <div class="search-input">
        <input id="cityInput" placeholder="Enter the city">
      </div>
      <button id="searchBtn" class="search-action">Search</button>
    </div>
  </div>
</header>

<main class="content">

  <h3 class="section-title">Recent Locations</h3>
  <div id="historyList" class="history"></div>

  <h3 class="section-title">Map</h3>

  <div class="map-search-box">
    <input id="mapSearchInput" placeholder="Search city on map">
    <button id="mapSearchBtn">Go</button>
    <button id="locateMeBtn">Locate Me</button>
  </div>

  <div id="owmMap"></div>

</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const OWM_KEY = "YOUR_OWM_API_KEY";

/* ----------------- MAIN SEARCH ----------------- */
document.getElementById('searchBtn').addEventListener('click', ()=>{
  const city = document.getElementById('cityInput').value.trim();
  if(!city) return alert("Enter a city name");
  window.location.href = "/weather/" + encodeURIComponent(city);
});

/* ----------------- MAP INIT ----------------- */
let map = L.map('owmMap').setView([20, 0], 3);
let searchMarker = null;

L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19})
.addTo(map);

L.tileLayer(`https://tile.openweathermap.org/map/temp_new/{z}/{x}/{y}.png?appid=${OWM_KEY}`, {
  maxZoom:19,
  opacity:0.55
}).addTo(map);

/* ----------------- CENTER ON CITY ----------------- */
async function centerCity(city){
  const url = `https://api.openweathermap.org/geo/1.0/direct?q=${city}&limit=1&appid=${OWM_KEY}`;
  const r = await fetch(url);
  const d = await r.json();
  if(!d.length) return;

  const {lat, lon} = d[0];

  if(searchMarker){ map.removeLayer(searchMarker); }

  searchMarker = L.marker([lat, lon]).addTo(map)
    .bindPopup(`<b>${city}</b>`).openPopup();

  map.setView([lat, lon], 10);
}

/* -------------- COMBINED ACTION FOR RECENT SEARCHES -------------- */
function openResultAndMap(city){
  centerCity(city);  
  window.location.href = "/weather/" + encodeURIComponent(city);
}

/* ----------------- MAP SEARCH ----------------- */
document.getElementById("mapSearchBtn").addEventListener("click", ()=>{
  const city = document.getElementById("mapSearchInput").value.trim();
  if(!city) return;
  centerCity(city);
  document.getElementById('searchBtn').addEventListener('click', async ()=>{
  const city = document.getElementById('cityInput').value.trim();
  if(!city) return alert("Enter a city name");

  // 1ï¸âƒ£ Fetch + store weather in DB
  let r = await fetch("/api/weather", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({city})
  });

  let data = await r.json();

  if(!r.ok){
      alert(data.error || "API error");
      return;
  }

  // 2ï¸âƒ£ Redirect after successful save
  window.location.href = "/weather/" + encodeURIComponent(city);
});

});

document.getElementById("mapSearchInput").addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){
    document.getElementById("mapSearchBtn").click();
  }
});

/* ----------------- LOCATE ME ----------------- */
document.getElementById("locateMeBtn").addEventListener("click", ()=>{
  if(!navigator.geolocation) return alert("Geolocation not supported");

  navigator.geolocation.getCurrentPosition(pos=>{
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;

    if(searchMarker){ map.removeLayer(searchMarker); }

    searchMarker = L.marker([lat, lon]).addTo(map)
      .bindPopup("<b>You are here</b>").openPopup();

    map.setView([lat, lon], 11);
  });
});

/* ----------------- LOAD RECENT HISTORY ----------------- */
async function loadHistory(){
  const r = await fetch('/api/history');
  const arr = await r.json();

  if(!arr.length){
    document.getElementById('historyList').innerHTML = "No recent searches";
    return;
  }

  document.getElementById('historyList').innerHTML = arr.map(item=>`
    <div class="card" onclick="openResultAndMap('${item.city}')">
      <div class="city">${item.city}</div>
      <div class="country">${item.country || ""}</div>
      <div class="mid-row">
        <div class="weather-icon">ðŸŒ™</div>
        <div class="temp">${Math.round(item.temperature)}Â°C</div>
      </div>
      <div class="small-desc">${item.dt}</div>
    </div>
  `).join('');
}

loadHistory();
</script>

</body>
</html>
